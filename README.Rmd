---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      fig.path = "README_figs/README-")
library("DDMEutils")
library("ggplot2")
library("knitr")
```
 
# DDME - Repositório de funções do R úteis para o dia a dia

## 1 `insp_outlier()`

Função base criada por Gabriel Motta, útil para detecção de outliers em séries temporais com base no pacote `anomalize`. As opções de uso são:

* Atômicos: 
    + vetor com inteiros ou numéricos
    + objeto ts
* Tabelas:
    + data.table
    + tbl_df  
    + data.frame

### Exemplo série unidimensional

Vetor sem data guardado em `x`:

```{r, echo=FALSE}
x <- rpois(100, 10); x[c(10,30)] <- c(50,65) ; x[c(50)] <- -10
qplot(seq_along(x), x, geom = "line", xlab = "Índice", ylab = "Valores")
```

O resultado da chamada é um objeto `data.table`. Note que a coluna `DATA` é criada arbitrariamente e nem faz sentido, já que o objeto inicial não possui referências temporais. 

```{r}
x_alterado <- insp_outlier(as.ts(x))
x_alterado[49:55]
```

```{r}
x_alterado %>% 
  melt(id = "DATA", measure = patterns("SERIE")) %>% 
  dplyr::mutate(variable = factor(variable, labels = c("Original","Imputada"))) %>% {.[]} %>% 
  ggplot(aes(DATA,value,color = variable)) +
  geom_line() +
  labs(x = "Índice", y = "Valores", color = "") + 
  theme(legend.position = "bottom")
```



### Múltiplas séries

O sentido das séries na tabela que estiver trabalhando pode ser por linhas ou colunas, e essencialmente este é o único cuidado que se deve ter para a chamada da função. O argumento `sentido` deve ser definido como __1 para linhas__ ou __2 para colunas__.

#### Séries nas linhas

Exemplo para tabelas com séries nas linhas:

```{r, echo = FALSE}
d1 = cbind(x,x + rnorm(100)) %>% t() %>% as.data.table() %>% .[, ID := 1:2] %>% setcolorder('ID') %>% {.[]}
d2 = data.table(DATA = seq(as.Date('2018-01-01'), by = 1, length.out = 100), SERIE1 = x, SERIE2 = round(rcauchy(100),4))
```


```{r}
d1[,1:10]

# Formato de saída "wide"
insp_outlier(d1, sentido = 1) %>% 
  dplyr::sample_n(10) %>% 
  {.[order(ID,PERIODO)]}

# Formato de saída "long"
insp_outlier(d1, sentido = 1, out_format = "long") %>% 
  dplyr::sample_n(10) %>% 
  {.[order(ID,PERIODO)]}
```


#### Séries nas colunas

Exemplo para tableas com séries nas colunas:

```{r}
d2[1:5]

# Formato de saída "wide"
insp_outlier(d2, sentido = 2) %>% head()

# Formato de saída "long"
insp_outlier(d2, sentido = 2, out_format = "long") %>% 
  dplyr::sample_n(10) %>% 
  {.[order(SERIE,DATA)]}
```


## 2 `na_prop()`

Função para checar proporção de valores faltantes num `data.table` com variáveis nas colunas.

### Exemplo para banco de dados `airquality`

```{r}
dados <- airquality %>% as.data.table()
head(dados)

# Geral
dados %>% na_prop()

# Restringindo proporcao
dados %>% na_prop(corte = 0.1)
```

## 3 Substituição de valores com `subs_any()` e `subs_na()`

### `subs_na()`

Função para substituição de NA em diversas variáveis de uma tabela. Os valores a substituir são especificados pelo nome das colunas na forma `subs_na(dados, col_1 = "?", col_2 = 999)` ou `subs_na(dados, list(col_1 = "?", col_2 = 999))`.

```{r}

dados %>% 
  subs_na(Ozone = 999, Solar.R = 999)

```

É possível também usar expressões regulares para substituição em múltiplas colunas por valor comum:

```{r}
# Substitui NA por 999 nas colunas que contém "." no nome.
dados %>% subs_na("\\." = 999)
```


### `subs_any()`

Substituição de qualquer valor `x` para qualquer valor `y` dentro de variáveis de tabela. A sintaxe se torna `subs_any(dados, col_1 = list(<valor>, <input>), col_2 = list(<valor>, <input>))`. Como em `subs_na()`, é possível referenciar mudanças para múltiplas colunas por expressão regular. 

```{r}
dados %>% 
  subs_any(Ozone = list(41, 10000), "\\." = list(190, 10000))
```

